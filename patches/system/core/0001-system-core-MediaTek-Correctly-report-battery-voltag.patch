From ae9589a57b52e0ab5b783ce82ebc648c258786f0 Mon Sep 17 00:00:00 2001
From: jmpfbmx <jmpf.bmx@gmail.com>
Date: Sun, 21 Aug 2022 16:38:35 +0200
Subject: [PATCH] system: core: MediaTek: Correctly report battery voltage

Change-Id: Id5010dbe1cc2ffff4a95251adf7ede47fd06db9f
---
 healthd/Android.mk         | 4 ++++
 healthd/BatteryMonitor.cpp | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/healthd/Android.mk b/healthd/Android.mk
index e0fb0cc..291f270 100644
--- a/healthd/Android.mk
+++ b/healthd/Android.mk
@@ -62,6 +62,10 @@ ifeq ($(strip $(BOARD_NO_CHARGER_LED)),true)
 LOCAL_CFLAGS += -DNO_CHARGER_LED
 endif
 
+ifeq ($(strip $(BOARD_USES_MTK_HARDWARE)),true)
+LOCAL_CFLAGS += -MTK_HARDWARE
+endif
+
 LOCAL_MODULE := libhealthd_internal
 LOCAL_C_INCLUDES := $(call project-path-for,recovery)
 LOCAL_EXPORT_C_INCLUDE_DIRS := \
diff --git a/healthd/BatteryMonitor.cpp b/healthd/BatteryMonitor.cpp
index d2088ee..83fbc69 100644
--- a/healthd/BatteryMonitor.cpp
+++ b/healthd/BatteryMonitor.cpp
@@ -227,7 +227,11 @@ bool BatteryMonitor::update(void) {
 
     props.batteryLevel = mBatteryFixedCapacity ?
         mBatteryFixedCapacity :
+#ifndef MTK_HARDWARE
         getIntField(mHealthdConfig->batteryCapacityPath);
+#else
+    props.batteryVoltage = getIntField(mHealthdConfig->batteryVoltagePath);
+#endif
     props.batteryVoltage = getIntField(mHealthdConfig->batteryVoltagePath) / 1000;
 
     if (!mHealthdConfig->batteryCurrentNowPath.isEmpty())
-- 
2.30.2

